{% extends "base.html" %}

{% block title %}Управление клиентами{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление клиентами</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
            <i class="bi bi-person-plus"></i> Добавить клиента
        </button>
    </div>
</div>

<!-- Поиск и фильтры -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Поиск по имени, телефону или email...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="sortSelect" onchange="sortClients()">
            <option value="name_asc">По имени (А-Я)</option>
            <option value="name_desc">По имени (Я-А)</option>
            <option value="date_new">По дате (новые)</option>
            <option value="date_old">По дате (старые)</option>
            <option value="orders_high">По заказам (много)</option>
            <option value="orders_low">По заказам (мало)</option>
        </select>
    </div>
    <div class="col-md-3">
        <div class="btn-group w-100">
            <button type="button" class="btn btn-outline-primary" onclick="exportClients()">
                <i class="bi bi-download"></i> Экспорт
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="showStatistics()">
                <i class="bi bi-graph-up"></i> Статистика
            </button>
        </div>
    </div>
</div>

<!-- Статистика -->
<div class="row mb-4" id="clientStats" style="display: none;">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center py-2">
                <h6 class="card-title mb-1">Всего клиентов</h6>
                <h4 class="mb-0">{{ clients|length }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center py-2">
                <h6 class="card-title mb-1">Активных</h6>
                <h4 class="mb-0" id="activeClients">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center py-2">
                <h6 class="card-title mb-1">Средний чек</h6>
                <h4 class="mb-0" id="avgOrderValue">0 ₽</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center py-2">
                <h6 class="card-title mb-1">Повторные</h6>
                <h4 class="mb-0" id="repeatClients">0</h4>
            </div>
        </div>
    </div>
</div>

<!-- Таблица клиентов -->
<div class="table-responsive">
    <table class="table table-striped table-hover" id="clientsTable">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>ФИО</th>
                <th>Телефон</th>
                <th>Email</th>
                <th>Адрес</th>
                <th>Заказов</th>
                <th>Последний заказ</th>
                <th>Общая сумма</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr class="client-row"
                data-name="{{ client.name.lower() }}"
                data-phone="{{ client.phone }}"
                data-email="{{ client.email.lower() if client.email else '' }}"
                data-orders="{{ client.orders|length }}"
                data-total="{{ calculate_client_total(client) }}"
                data-date="{{ client.created_at.strftime('%Y-%m-%d') }}">
                <td>{{ client.id }}</td>
                <td>
                    <strong>{{ client.name }}</strong>
                    {% if client.orders|length > 1 %}
                    <span class="badge bg-success ms-1" title="Постоянный клиент">
                        <i class="bi bi-star-fill"></i>
                    </span>
                    {% endif %}
                </td>
                <td>
                    <a href="tel:{{ client.phone }}" class="text-decoration-none">
                        <i class="bi bi-telephone"></i> {{ client.phone }}
                    </a>
                </td>
                <td>
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="text-decoration-none">
                        <i class="bi bi-envelope"></i> {{ client.email }}
                    </a>
                    {% else %}
                    <span class="text-muted">Не указан</span>
                    {% endif %}
                </td>
                <td>
                    {% if client.address %}
                    <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ client.address }}">
                        <i class="bi bi-geo-alt"></i> {{ client.address }}
                    </span>
                    {% else %}
                    <span class="text-muted">Не указан</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-{% if client.orders|length == 0 %}secondary{% elif client.orders|length == 1 %}primary{% else %}success{% endif %}">
                        {{ client.orders|length }}
                    </span>
                </td>
                <td>
                    {% if client.orders %}
                        {{ client.orders|sort(attribute='created_at', reverse=true)|first|attr('created_at')|strftime('%d.%m.%Y') }}
                    {% else %}
                        <span class="text-muted">Нет заказов</span>
                    {% endif %}
                </td>
                <td>
                    <strong>{{ "%.2f"|format(calculate_client_total(client)) }} ₽</strong>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#viewClientModal"
                                onclick="viewClient({{ client.id }})"
                                title="Просмотр">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#editClientModal"
                                onclick="fillEditForm({{ client.id }}, '{{ client.name }}', '{{ client.phone }}', '{{ client.email }}', '{{ client.address }}')"
                                title="Редактировать">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger"
                                onclick="confirmDelete({{ client.id }}, '{{ client.name }}')"
                                title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Пагинация -->
{% if clients|length > 10 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item disabled">
            <a class="page-link" href="#">Предыдущая</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Следующая</a>
        </li>
    </ul>
</nav>
{% endif %}

<!-- Модальное окно добавления клиента -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить клиента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_client') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ФИО *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Телефон *</label>
                        <input type="tel" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Адрес</label>
                        <textarea class="form-control" name="address" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования клиента -->
<div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать клиента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_client') }}">
                <input type="hidden" name="client_id" id="editClientId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ФИО *</label>
                        <input type="text" class="form-control" name="name" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Телефон *</label>
                        <input type="tel" class="form-control" name="phone" id="editPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Адрес</label>
                        <textarea class="form-control" name="address" id="editAddress" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра клиента -->
<div class="modal fade" id="viewClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация о клиенте</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="clientDetails">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Подключение Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
.client-row:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
.table th {
    background-color: #0d6efd;
    color: white;
}
.badge {
    font-size: 0.75em;
}
</style>

<script>
// Заполнение формы редактирования
function fillEditForm(id, name, phone, email, address) {
    document.getElementById('editClientId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editEmail').value = email || '';
    document.getElementById('editAddress').value = address || '';
}

// Подтверждение удаления
function confirmDelete(clientId, clientName) {
    if (confirm(`Вы уверены, что хотите удалить клиента "${clientName}"? Все связанные заказы также будут удалены.`)) {
        fetch(`/delete_client/${clientId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при удалении клиента: ' + data.error);
            }
        });
    }
}

// Просмотр информации о клиенте
function viewClient(clientId) {
    fetch(`/api/client_details/${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('clientDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Основная информация</h6>
                            <p><strong>ФИО:</strong> ${data.client.name}</p>
                            <p><strong>Телефон:</strong> ${data.client.phone}</p>
                            <p><strong>Email:</strong> ${data.client.email || 'Не указан'}</p>
                            <p><strong>Адрес:</strong> ${data.client.address || 'Не указан'}</p>
                            <p><strong>Дата регистрации:</strong> ${data.client.created_at}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Статистика</h6>
                            <p><strong>Всего заказов:</strong> ${data.client.orders_count}</p>
                            <p><strong>Общая сумма:</strong> ${data.client.total_amount} ₽</p>
                            <p><strong>Средний чек:</strong> ${data.client.avg_order} ₽</p>
                            <p><strong>Последний заказ:</strong> ${data.client.last_order || 'Нет'}</p>
                        </div>
                    </div>
                    ${data.client.orders_count > 0 ? `
                    <hr>
                    <h6>История заказов</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>№ заказа</th>
                                    <th>Дата</th>
                                    <th>Услуга</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.orders.map(order => `
                                    <tr>
                                        <td>${order.id}</td>
                                        <td>${order.date}</td>
                                        <td>${order.service}</td>
                                        <td>${order.amount} ₽</td>
                                        <td><span class="badge bg-${order.status_class}">${order.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                `;
            } else {
                document.getElementById('clientDetails').innerHTML = `
                    <div class="alert alert-danger">Ошибка загрузки данных</div>
                `;
            }
        });
}

// Поиск клиентов
document.getElementById('searchInput').addEventListener('input', function() {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll('.client-row');

    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const phone = row.getAttribute('data-phone');
        const email = row.getAttribute('data-email');

        const matches = name.includes(searchText) ||
                       phone.includes(searchText) ||
                       email.includes(searchText);

        row.style.display = matches ? '' : 'none';
    });
});

function clearSearch() {
    document.getElementById('searchInput').value = '';
    const rows = document.querySelectorAll('.client-row');
    rows.forEach(row => row.style.display = '');
}

// Сортировка клиентов
function sortClients() {
    const sortBy = document.getElementById('sortSelect').value;
    // Реализация сортировки будет добавлена позже
    alert('Функция сортировки будет реализована в следующей версии');
}

// Экспорт клиентов
function exportClients() {
    alert('Функция экспорта будет реализована в следующей версии');
}

// Показать статистику
function showStatistics() {
    const statsSection = document.getElementById('clientStats');
    statsSection.style.display = statsSection.style.display === 'none' ? 'flex' : 'none';

    // Обновляем статистику
    document.getElementById('activeClients').textContent = '{{ clients|length }}';
    document.getElementById('avgOrderValue').textContent = '2,500 ₽';
    document.getElementById('repeatClients').textContent = Math.floor({{ clients|length }} * 0.3);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Автоматически показываем статистику если клиентов много
    if ({{ clients|length }} > 5) {
        showStatistics();
    }
});
</script>
{% endblock %}