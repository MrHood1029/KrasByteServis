{% extends "base.html" %}

{% block title %}Управление складом{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление складом</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSparePartModal">
            <i class="bi bi-plus-circle"></i> Добавить запчасть
        </button>
    </div>
</div>

<!-- Фильтры и поиск -->
<div class="row mb-4">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchInput" placeholder="Поиск по названию или артикулу...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="stockFilter">
            <option value="all">Все запчасти</option>
            <option value="low">Низкий запас</option>
            <option value="out">Нет в наличии</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">Сбросить фильтры</button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover" id="warehouseTable">
        <thead class="table-dark">
            <tr>
                <th>Артикул</th>
                <th>Название</th>
                <th>Количество</th>
                <th>Себестоимость</th>
                <th>Цена продажи</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for part in spare_parts %}
            <tr class="spare-part-row"
                data-name="{{ part.name.lower() }}"
                data-article="{{ part.article.lower() if part.article else '' }}"
                data-stock="{{ part.quantity }}">
                <td>{{ part.article or 'Не указан' }}</td>
                <td>{{ part.name }}</td>
                <td>
                    <span class="badge bg-{% if part.quantity == 0 %}danger{% elif part.quantity <= part.min_stock %}warning{% else %}success{% endif %}">
                        {{ part.quantity }} шт.
                    </span>
                </td>
                <td>{{ "%.2f"|format(part.cost_price) }} ₽</td>
                <td>{{ "%.2f"|format(part.retail_price) }} ₽</td>
                <td>
                    {% if part.quantity == 0 %}
                        <span class="badge bg-danger">Нет в наличии</span>
                    {% elif part.quantity <= part.min_stock %}
                        <span class="badge bg-warning">Низкий запас</span>
                    {% else %}
                        <span class="badge bg-success">В наличии</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#editSparePartModal"
                            data-id="{{ part.id }}"
                            data-name="{{ part.name }}"
                            data-article="{{ part.article }}"
                            data-quantity="{{ part.quantity }}"
                            data-cost="{{ part.cost_price }}"
                            data-retail="{{ part.retail_price }}"
                            data-minstock="{{ part.min_stock }}"
                            onclick="fillEditForm(this)">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="confirmDelete({{ part.id }}, '{{ part.name }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно добавления запчасти -->
<div class="modal fade" id="addSparePartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить запчасть</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_spare_part') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название запчасти *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Артикул</label>
                        <input type="text" class="form-control" name="article">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Количество *</label>
                            <input type="number" class="form-control" name="quantity" value="0" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Минимальный запас *</label>
                            <input type="number" class="form-control" name="min_stock" value="5" min="1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Себестоимость (₽) *</label>
                            <input type="number" step="0.01" class="form-control" name="cost_price" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Цена продажи (₽) *</label>
                            <input type="number" step="0.01" class="form-control" name="retail_price" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования запчасти -->
<div class="modal fade" id="editSparePartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать запчасть</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_spare_part') }}">
                <input type="hidden" name="part_id" id="editPartId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название запчасти *</label>
                        <input type="text" class="form-control" name="name" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Артикул</label>
                        <input type="text" class="form-control" name="article" id="editArticle">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Количество *</label>
                            <input type="number" class="form-control" name="quantity" id="editQuantity" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Минимальный запас *</label>
                            <input type="number" class="form-control" name="min_stock" id="editMinStock" min="1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Себестоимость (₽) *</label>
                            <input type="number" step="0.01" class="form-control" name="cost_price" id="editCostPrice" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Цена продажи (₽) *</label>
                            <input type="number" step="0.01" class="form-control" name="retail_price" id="editRetailPrice" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Подключение Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
.spare-part-row:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
.table th {
    background-color: #0d6efd;
    color: white;
}
</style>

<script>
// Функция для заполнения формы редактирования
function fillEditForm(button) {
    const partId = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');
    const article = button.getAttribute('data-article');
    const quantity = button.getAttribute('data-quantity');
    const costPrice = button.getAttribute('data-cost');
    const retailPrice = button.getAttribute('data-retail');
    const minStock = button.getAttribute('data-minstock');

    document.getElementById('editPartId').value = partId;
    document.getElementById('editName').value = name;
    document.getElementById('editArticle').value = article || '';
    document.getElementById('editQuantity').value = quantity;
    document.getElementById('editCostPrice').value = costPrice;
    document.getElementById('editRetailPrice').value = retailPrice;
    document.getElementById('editMinStock').value = minStock;
}

// Функция подтверждения удаления
function confirmDelete(partId, partName) {
    if (confirm(`Вы уверены, что хотите удалить запчасть "${partName}"?`)) {
        fetch(`/delete_spare_part/${partId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при удалении запчасти');
            }
        });
    }
}

// Фильтрация и поиск
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('stockFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;

    const rows = document.querySelectorAll('.spare-part-row');

    rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const article = row.getAttribute('data-article');
        const stock = parseInt(row.getAttribute('data-stock'));

        const matchesSearch = name.includes(searchText) || article.includes(searchText);
        let matchesStock = true;

        if (stockFilter === 'low') {
            const minStock = 5; // Можно получить из данных, если нужно
            matchesStock = stock > 0 && stock <= minStock;
        } else if (stockFilter === 'out') {
            matchesStock = stock === 0;
        }

        row.style.display = (matchesSearch && matchesStock) ? '' : 'none';
    });
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('stockFilter').value = 'all';
    filterTable();
}
</script>
{% endblock %}